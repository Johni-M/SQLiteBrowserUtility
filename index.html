<!DOCTYPE html>
<html lang='de' class='notranslate' translate='no'>

<head>
    <meta name='google' content='notranslate' />
    <meta charset='UTF-8'>
    <meta name='description' content='Verteilungplan'>
    <meta name='keywords' content=''>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv='X-UA-Compatible' content='IE=Edge,chrome=1' />
    <meta http-equiv='Content-Language' content='de' />
    <meta name='msapplication-TileColor' content='#ffffff' />
    <meta name='theme-color' content='#ffffff' />
    <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent' />
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <meta name='mobile-web-app-capable' content='yes' />
    <script src='js/sql-browser.min.js'></script>
    <link href='css/bootstrap-4.5.2.min.css' rel='stylesheet' type='text/css' />
    <link href='css/main.css' rel='stylesheet' type='text/css' />
    <title>Verteilungsplan</title>
</head>

<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <div class='container-fluid'>
        <div class=''>
            <div class=''>

                <input id='upload' type='file' />
                Diensplan von ClinicPlanner importieren: <input id='upload_html' type='file' />

                <hr class='invisible-divider'>

                <div id='tableRecords' class='table-responsive'></div>

                <p id='errorDisplay' class='m-0 p-0 small text-danger'></p>

            </div>
        </div>
    </div>

    <script src='js/ie10-viewport-bug-workaround.js'></script>
    <script src='js/bootstrap-native-v4.js'></script>

    <script>
        if (document.readyState === 'complete' || document.readyState !== 'loading' && !document.documentElement.doScroll) {
            callback();
        } else {
            document.addEventListener('DOMContentLoaded', async () => {
                //console.log('DOMContentLoaded');

                if (!window.FileReader) {
                    errorDisplay.innerHTML = '⛔ WARNING: Your browser does not support HTML5 \'FileReader\' function required to open a file.';
                    return;
                }
                if (!window.Blob) {
                    errorDisplay.innerHTML = '⛔ WARNING: Your browser does not support HTML5 \'Blob\' function required to save a file.';
                    return;
                }


                async function renderDatatable(resultset, tableRecordsEle) {
                    try {
                        tableRecordsEle.innerHTML = '';

                        let tableHtmlStr = '';
                        tableHtmlStr += '<table class="table table-striped table-condensed small table-bordered">';
                        tableHtmlStr += '<thead>';
                        tableHtmlStr += '<tr><th></th><th>' + resultset[0]['columns'].join('</th><th>') + '</th></tr>';
                        tableHtmlStr += '</thead>';
                        tableHtmlStr += '<tbody>';
                        let tableValues = resultset[0]['values'];
                        for (let v in tableValues) {
                            tableHtmlStr += '<tr><th>' + (parseInt(v) + 1) + '</th><td>' + tableValues[v].join('</td><td>') + '</td></tr>';
                        }
                        tableHtmlStr += '</tbody>';
                        tableHtmlStr += '</table>';
                        tableHtmlStr += '</div>';
                        tableRecordsEle.innerHTML = tableHtmlStr;

                        errorDisplay.innerHTML = '';

                        return await Promise.resolve('success');
                    } catch (err) {
                        throw new Error(err.message);
                    }
                }


                function readFileAsArrayBuffer(file) {
                    return new Promise((resolve, reject) => {
                        let fileredr = new FileReader();
                        fileredr.onload = () => resolve(fileredr.result);
                        fileredr.onerror = () => reject(fileredr);
                        fileredr.readAsArrayBuffer(file);
                    });
                }


                // ---- upload ----
                var upload = document.getElementById('upload');

                // the database
                var db = null;

                // SQL query
                var stmt = '';
                // SQL query result
                var resultset = [];

                var tableRecords = document.getElementById('tableRecords');

                upload.addEventListener('change', async (ev) => {
                    errorDisplay.innerHTML = '';

                    let file = ev.currentTarget.files[0];
                    if (!file) return;

                    try {

                        let arrayBuffer = await readFileAsArrayBuffer(file);
                        let uInt8Array = new Uint8Array(arrayBuffer);
                        db = new SQL.Database(uInt8Array);


                        // render datatable records
                        stmt = 'SELECT * FROM sqlite_master';
                        resultset = db.exec(stmt);
                        renderDatatable(resultset, tableRecords);


                    } catch (err) {
                        errorDisplay.innerHTML = '';
                        errorDisplay.innerHTML = `⚠ ERROR: ${err.message}`;
                    }
                }, false); // upload file change event


                document.getElementById('upload_html').addEventListener('change', importClinicPlanner)

                function importClinicPlanner() {
                    let files = this.files;
                    if (files.length === 0) {
                        console.log('No file is selected');
                        return;
                    }

                    let reader = new FileReader();
                    reader.readAsText(files[0], 'ISO-8859-1');

                    reader.onload = function (event) {

                        const parser = new DOMParser();
                        const ClinicPlan = parser.parseFromString(event.target.result, "text/html");


                        let table = ClinicPlan.getElementsByTagName('table')[0];
                        
                        // start reading on table row x
                        const ClinicPlanRowStart = 2;
                        // skip every x lines
                        const ClinicPlanRowOffset = 4;

                        let ClinicPlanName = "";
                        let ClinicPlanFirstname = "";

                        let Dienstplan = [];

                        console.log("Anz. Mitarbeiter: " + (table.rows.length-ClinicPlanRowStart)/ClinicPlanRowOffset);

                        for (let i = ClinicPlanRowStart, row; row = table.rows[i]; i+=ClinicPlanRowOffset) {

                            ClinicPlanName = row.cells[0].innerText.trim();
                            ClinicPlanFirstname = table.rows[i+1].cells[0].innerText.trim();
                            
                            console.log(ClinicPlanName + ", " + ClinicPlanFirstname);

                            /*
                            for (let j = 0, cell; cell = row.cells[j]; j++) {
                                console.log(cell.innerText);
                            }
                            */
                        }

                    };

                }

                    
            }); // DOMContentLoaded
        }
    </script>
</body>

</html>